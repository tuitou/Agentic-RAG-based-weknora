# 容器镜像重构说明

## 概述

本文档说明了对 `docreader` 容器镜像的重构改进，包括PDF解析功能的增强、环境变量配置和构建优化。

## 主要改进

### 1. PDF解析功能增强

- ✅ **备用解析器支持**：当pdfplumber失败时自动切换到pypdf
- ✅ **详细的错误日志**：记录完整的错误信息和堆栈跟踪
- ✅ **PDF文件验证**：解析前验证PDF文件格式
- ✅ **页面级容错**：单页失败不影响其他页面处理
- ✅ **表格处理优化**：改进表格提取的错误处理

### 2. Docker镜像优化

#### 新增功能
- ✅ **依赖验证**：构建时验证PDF解析库是否正确安装
- ✅ **健康检查**：内置Docker健康检查
- ✅ **环境变量配置**：支持通过环境变量配置PDF解析行为
- ✅ **临时目录管理**：自动创建PDF缓存目录
- ✅ **poppler-utils支持**：添加PDF工具集支持

#### 构建优化
- ✅ **缓存清理**：构建后清理pip缓存减少镜像大小
- ✅ **依赖验证**：构建时验证关键依赖可用性
- ✅ **日志优化**：设置Python日志输出到stdout/stderr

### 3. 环境变量配置

新增以下环境变量支持：

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `OCR_BACKEND` | `paddle` | OCR后端类型（paddle/nanonets等） |
| `OCR_API_BASE_URL` | - | OCR API服务地址（如果使用远程OCR） |
| `GRPC_PORT` | `50051` | gRPC服务端口 |
| `GRPC_MAX_WORKERS` | `4` | gRPC最大工作线程数 |
| `LOG_LEVEL` | `INFO` | 日志级别（DEBUG/INFO/WARNING/ERROR） |
| `EXTERNAL_HTTP_PROXY` | - | 外部HTTP代理（用于下载图片等） |
| `EXTERNAL_HTTPS_PROXY` | - | 外部HTTPS代理 |

## 构建镜像

### 方法1：使用docker-compose构建

```bash
# 构建docreader服务镜像
docker-compose build docreader

# 构建并启动所有服务
docker-compose up -d
```

### 方法2：直接使用Docker构建

```bash
# 构建镜像
docker build -f docker/Dockerfile.docreader -t wechatopenai/weknora-docreader:latest .

# 或者指定架构（多平台构建）
docker buildx build --platform linux/amd64,linux/arm64 \
  -f docker/Dockerfile.docreader \
  -t wechatopenai/weknora-docreader:latest \
  --push .
```

### 方法3：使用Makefile（如果存在）

```bash
make build-docreader
```

## 配置环境变量

### 在docker-compose.yml中配置

编辑 `docker-compose.yml` 文件，在 `docreader` 服务的 `environment` 部分添加或修改环境变量：

```yaml
docreader:
  environment:
    - OCR_BACKEND=paddle
    - LOG_LEVEL=DEBUG  # 启用详细日志
    - GRPC_MAX_WORKERS=8  # 增加工作线程
    - EXTERNAL_HTTP_PROXY=http://proxy.example.com:8080
```

### 使用.env文件

创建或编辑 `.env` 文件：

```bash
# PDF解析配置
OCR_BACKEND=paddle
LOG_LEVEL=INFO
GRPC_MAX_WORKERS=4
GRPC_PORT=50051

# 代理配置（如果需要）
EXTERNAL_HTTP_PROXY=http://proxy.example.com:8080
EXTERNAL_HTTPS_PROXY=http://proxy.example.com:8080
```

### 运行时配置

```bash
docker run -e OCR_BACKEND=paddle \
           -e LOG_LEVEL=DEBUG \
           -e GRPC_MAX_WORKERS=8 \
           wechatopenai/weknora-docreader:latest
```

## 验证安装

### 检查容器健康状态

```bash
# 查看容器状态
docker ps | grep docreader

# 检查健康状态
docker inspect WeKnora-docreader | grep Health -A 10
```

### 查看日志

```bash
# 查看实时日志
docker logs -f WeKnora-docreader

# 查看最近100行日志
docker logs --tail 100 WeKnora-docreader

# 查看包含ERROR的日志
docker logs WeKnora-docreader 2>&1 | grep ERROR
```

### 测试PDF解析功能

```bash
# 进入容器
docker exec -it WeKnora-docreader bash

# 验证PDF库
python -c "import pdfplumber; import pypdf; print('PDF libraries OK')"

# 测试OCR引擎
python -c "from parser.ocr_engine import OCREngine; print('OCR engine OK')"
```

## 故障排查

### 问题1：PDF解析失败

**症状**：日志显示"Failed to parse PDF document"

**排查步骤**：
1. 检查日志级别是否为DEBUG以获取详细信息
   ```bash
   docker logs WeKnora-docreader | grep -i "pdf\|error"
   ```

2. 验证PDF文件格式
   ```bash
   # 在容器中检查PDF文件头
   docker exec WeKnora-docreader head -c 4 /path/to/file.pdf
   # 应该输出: %PDF
   ```

3. 检查依赖库
   ```bash
   docker exec WeKnora-docreader python -c "import pdfplumber; import pypdf"
   ```

**解决方案**：
- 确保PDF文件未损坏
- 检查日志中的详细错误信息
- 如果pdfplumber失败，系统会自动尝试pypdf备用解析器

### 问题2：OCR功能不可用

**症状**：日志显示"OCR engine initialization failed"

**排查步骤**：
1. 检查OCR后端配置
   ```bash
   docker exec WeKnora-docreader env | grep OCR
   ```

2. 验证PaddleOCR模型
   ```bash
   docker exec WeKnora-docreader ls -la /root/.paddleocr/whl/
   ```

**解决方案**：
- 检查`OCR_BACKEND`环境变量设置
- 如果使用远程OCR，检查`OCR_API_BASE_URL`配置
- 确保PaddleOCR模型文件完整

### 问题3：容器启动失败

**症状**：容器无法启动或立即退出

**排查步骤**：
1. 查看容器退出代码
   ```bash
   docker inspect WeKnora-docreader | grep ExitCode
   ```

2. 查看完整启动日志
   ```bash
   docker logs WeKnora-docreader
   ```

3. 检查健康检查
   ```bash
   docker inspect WeKnora-docreader | grep Health -A 20
   ```

**解决方案**：
- 检查端口是否被占用
- 验证环境变量配置
- 检查依赖服务（如MinIO）是否可用

### 问题4：内存不足

**症状**：处理大型PDF时容器被OOM杀死

**解决方案**：
1. 增加容器内存限制
   ```yaml
   docreader:
     deploy:
       resources:
         limits:
           memory: 4G
   ```

2. 减少并发工作线程
   ```yaml
   environment:
     - GRPC_MAX_WORKERS=2
   ```

## 性能优化建议

### 1. 调整工作线程数

根据服务器CPU核心数调整：
```yaml
environment:
  - GRPC_MAX_WORKERS=8  # 建议为CPU核心数的1-2倍
```

### 2. 启用详细日志（调试时）

```yaml
environment:
  - LOG_LEVEL=DEBUG
```

### 3. 配置代理（如果需要）

```yaml
environment:
  - EXTERNAL_HTTP_PROXY=http://proxy:8080
  - EXTERNAL_HTTPS_PROXY=http://proxy:8080
```

### 4. 资源限制

```yaml
docreader:
  deploy:
    resources:
      limits:
        cpus: '4'
        memory: 4G
      reservations:
        cpus: '2'
        memory: 2G
```

## 更新镜像

### 拉取最新镜像

```bash
docker-compose pull docreader
docker-compose up -d docreader
```

### 重新构建镜像

```bash
# 不使用缓存重新构建
docker-compose build --no-cache docreader

# 启动服务
docker-compose up -d docreader
```

## 相关文件

- `docker/Dockerfile.docreader` - docreader服务Dockerfile
- `docker-compose.yml` - Docker Compose配置文件
- `docreader/parser/pdf_parser.py` - PDF解析器实现
- `docreader/pyproject.toml` - Python依赖配置

## 版本信息

- **Python版本**：3.10.18
- **基础镜像**：python:3.10.18-bookworm
- **PDF解析库**：
  - pdfplumber >= 0.11.7
  - pypdf >= 6.1.3
- **OCR引擎**：PaddleOCR >= 2.10.0

## 支持

如遇到问题，请提供以下信息：
1. Docker版本：`docker --version`
2. Docker Compose版本：`docker-compose --version`
3. 容器日志：`docker logs WeKnora-docreader`
4. 环境变量配置
5. PDF文件样本（如可能）

