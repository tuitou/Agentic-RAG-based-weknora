# çŸ¥è¯†åº“æ–‡æ¡£åˆ é™¤æœºåˆ¶ä¼˜åŒ–è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº† WeKnora ç³»ç»Ÿä¸­çŸ¥è¯†åº“æ–‡æ¡£åˆ é™¤æœºåˆ¶çš„ä¼˜åŒ–æ”¹è¿›ï¼ŒåŒ…æ‹¬å¯¹è§£æå¤±è´¥æ–‡æ¡£åˆ é™¤é—®é¢˜çš„ä¿®å¤ã€åŸä»£ç è®¾è®¡ç†å¿µåˆ†æï¼Œä»¥åŠæ–‡æ¡£è§£æå¤±è´¥çš„ä¸åŒé˜¶æ®µå’Œèµ„æºçŠ¶æ€è¯´æ˜ã€‚

---

## ğŸ”§ é—®é¢˜èƒŒæ™¯

### åŸå§‹é—®é¢˜

**é—®é¢˜æè¿°**ï¼šè§£æå¤±è´¥çš„çŸ¥è¯†åº“æ–‡æ¡£æ— æ³•åˆ é™¤

**é—®é¢˜è¡¨ç°**ï¼š
- å½“æ–‡æ¡£è§£æå¤±è´¥ï¼ˆ`ParseStatus = "failed"`ï¼‰æ—¶ï¼Œå°è¯•åˆ é™¤æ–‡æ¡£ä¼šå¤±è´¥
- åˆ é™¤æ“ä½œæŠ¥é”™ï¼Œå¯¼è‡´æ–‡æ¡£è®°å½•æ®‹ç•™åœ¨æ•°æ®åº“ä¸­
- ç”¨æˆ·æ— æ³•æ¸…ç†å¤±è´¥çš„æ–‡æ¡£ï¼Œå½±å“ç³»ç»Ÿä½¿ç”¨ä½“éªŒ

### é—®é¢˜æ ¹å› 

åŸä»£ç é‡‡ç”¨**ä¸¥æ ¼ä¸€è‡´æ€§**çš„è®¾è®¡ç†å¿µï¼Œè¦æ±‚åˆ é™¤æ“ä½œå¿…é¡»æˆåŠŸåˆ é™¤æ‰€æœ‰ç›¸å…³èµ„æºï¼ˆembeddingsã€chunksã€çŸ¥è¯†å›¾è°±ç­‰ï¼‰ï¼Œå¦åˆ™æ•´ä¸ªåˆ é™¤æ“ä½œå¤±è´¥ã€‚å¯¹äºè§£æå¤±è´¥çš„æ–‡æ¡£ï¼Œè¿™äº›èµ„æºå¯èƒ½ä»æœªåˆ›å»ºæˆ–éƒ¨åˆ†åˆ›å»ºï¼Œå¯¼è‡´åˆ é™¤æ“ä½œæ— æ³•å®Œæˆã€‚

---

## ğŸ¯ åŸä»£ç è®¾è®¡ç†å¿µåˆ†æ

### è®¾è®¡ç†å¿µï¼šä¸¥æ ¼ä¸€è‡´æ€§ï¼ˆStrict Consistencyï¼‰

åŸä»£ç çš„è®¾è®¡éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

#### 1. **æ•°æ®å®Œæ•´æ€§ä¼˜å…ˆ**

```go
// åŸä»£ç é€»è¾‘ç¤ºä¾‹
if err := retrieveEngine.DeleteByKnowledgeIDList(...); err != nil {
    return err  // ä»»ä½•å¤±è´¥éƒ½ä¼šä¸­æ–­åˆ é™¤
}
```

**è®¾è®¡æ„å›¾**ï¼š
- ç¡®ä¿æ‰€æœ‰ç›¸å…³æ•°æ®éƒ½è¢«å®Œå…¨æ¸…ç†
- é¿å…æ•°æ®æ®‹ç•™å’Œä¸ä¸€è‡´çŠ¶æ€
- ä¿è¯æ•°æ®å®Œæ•´æ€§

**å‡è®¾å‰æ**ï¼š
- æ‰€æœ‰æ–‡æ¡£éƒ½å·²æˆåŠŸè§£æ
- æ‰€æœ‰èµ„æºï¼ˆembeddingsã€chunksã€çŸ¥è¯†å›¾è°±ï¼‰éƒ½å·²åˆ›å»º
- `EmbeddingModelID` å§‹ç»ˆæœ‰æ•ˆ

#### 2. **é”™è¯¯ä¼ æ’­æœºåˆ¶**

åŸä»£ç ä½¿ç”¨ `errgroup.Group{}` å¹¶è¡Œæ‰§è¡Œå¤šä¸ªåˆ é™¤æ“ä½œï¼š

```go
wg := errgroup.Group{}
wg.Go(func() error {
    // åˆ é™¤ embeddings
    if err := ...; err != nil {
        return err  // ä»»ä½•é”™è¯¯éƒ½ä¼šä¼ æ’­
    }
})
wg.Go(func() error {
    // åˆ é™¤ chunks
    if err := ...; err != nil {
        return err
    }
})
// ...

if err = wg.Wait(); err != nil {
    return err  // ä»»ä½• goroutine çš„é”™è¯¯éƒ½ä¼šå¯¼è‡´æ•´ä¸ªæ“ä½œå¤±è´¥
}
```

**è®¾è®¡æ„å›¾**ï¼š
- å¹¶è¡Œæ‰§è¡Œæé«˜æ•ˆç‡
- ä»»ä½•å­æ“ä½œå¤±è´¥éƒ½ä¼šä¸­æ–­æ•´ä¸ªæµç¨‹
- ç¡®ä¿æ‰€æœ‰èµ„æºéƒ½è¢«æˆåŠŸåˆ é™¤

#### 3. **åŸä»£ç çš„é™åˆ¶åœºæ™¯**

##### åœºæ™¯1ï¼šè§£æå¤±è´¥çš„æ–‡æ¡£
```
æ–‡æ¡£ä¸Šä¼  â†’ è§£æå¤±è´¥ â†’ ParseStatus = "failed"
â†’ EmbeddingModelID å¯èƒ½ä¸ºç©ºæˆ–æ— æ•ˆ
â†’ æ²¡æœ‰ç”Ÿæˆ chunks
â†’ æ²¡æœ‰ç”Ÿæˆ embeddings  
â†’ æ²¡æœ‰æ„å»ºçŸ¥è¯†å›¾è°±
```
**ç»“æœ**ï¼šåˆ é™¤æ—¶è·å– embedding model å¤±è´¥ â†’ æ•´ä¸ªåˆ é™¤å¤±è´¥

##### åœºæ™¯2ï¼šéƒ¨åˆ†èµ„æºç¼ºå¤±
```
æ–‡æ¡£éƒ¨åˆ†å¤„ç†æˆåŠŸ â†’ æŸäº›èµ„æºåˆ›å»ºå¤±è´¥
â†’ åˆ é™¤æ—¶é‡åˆ°ç¼ºå¤±çš„èµ„æº â†’ æ“ä½œå¤±è´¥ â†’ æ•´ä¸ªåˆ é™¤å¤±è´¥
```

##### åœºæ™¯3ï¼šèµ„æºå·²æ‰‹åŠ¨æ¸…ç†
```
ç®¡ç†å‘˜æ‰‹åŠ¨æ¸…ç†äº†æŸäº›èµ„æº
â†’ åˆ é™¤æ—¶æ‰¾ä¸åˆ°èµ„æº â†’ æ“ä½œå¤±è´¥ â†’ æ•´ä¸ªåˆ é™¤å¤±è´¥
```

### åŸä»£ç çš„è®¾è®¡ç¼ºé™·

1. **ç¼ºä¹çŠ¶æ€æ£€æŸ¥**ï¼šæœªæ£€æŸ¥æ–‡æ¡£çš„è§£æçŠ¶æ€æˆ–èµ„æºæ˜¯å¦å­˜åœ¨
2. **é”™è¯¯å¤„ç†è¿‡äºä¸¥æ ¼**ï¼šå°†éå…³é”®é”™è¯¯å½“ä½œå…³é”®é”™è¯¯å¤„ç†
3. **ç¼ºä¹å®¹é”™æœºåˆ¶**ï¼šæ²¡æœ‰åŒºåˆ†"èµ„æºä¸å­˜åœ¨"å’Œ"çœŸæ­£çš„åˆ é™¤å¤±è´¥"

---

## âœ¨ ä¼˜åŒ–æ–¹æ¡ˆ

### æ ¸å¿ƒæ”¹è¿›ï¼šä»ä¸¥æ ¼æ¨¡å¼åˆ°å®¹é”™æ¨¡å¼

å°†åˆ é™¤æ“ä½œä»**"ä¸¥æ ¼æ¨¡å¼"**æ”¹ä¸º**"å®¹é”™æ¨¡å¼"**ï¼š

| æ–¹é¢ | åŸä»£ç  | ä¼˜åŒ–å |
|------|--------|--------|
| é”™è¯¯å¤„ç† | ä¸¥æ ¼æ¨¡å¼ï¼Œä»»ä½•å¤±è´¥éƒ½ä¸­æ–­ | å®¹é”™æ¨¡å¼ï¼Œéå…³é”®å¤±è´¥ç»§ç»­æ‰§è¡Œ |
| è§£æå¤±è´¥æ–‡æ¡£ | æ— æ³•åˆ é™¤ | å¯ä»¥æ­£å¸¸åˆ é™¤ |
| èµ„æºç¼ºå¤±å¤„ç† | ç›´æ¥å¤±è´¥ | è·³è¿‡å¹¶è®°å½•è­¦å‘Š |
| æ•°æ®å®Œæ•´æ€§ | è¦æ±‚æ‰€æœ‰èµ„æºéƒ½åˆ é™¤ | ä¼˜å…ˆåˆ é™¤æ•°æ®åº“è®°å½• |
| æ—¥å¿—è®°å½• | é”™è¯¯æ—¥å¿— | è­¦å‘Šæ—¥å¿—ï¼ˆæ›´è¯¦ç»†ï¼‰ |

### å…·ä½“ä¿®æ”¹å†…å®¹

#### 1. `DeleteKnowledge` å‡½æ•°ï¼ˆå•ä¸ªæ–‡æ¡£åˆ é™¤ï¼‰

##### ä¿®æ”¹1ï¼šåˆ é™¤ Embeddings çš„å®¹é”™å¤„ç†

**ä¿®æ”¹å‰**ï¼š
```go
embeddingModel, err := s.modelService.GetEmbeddingModel(ctx, knowledge.EmbeddingModelID)
if err != nil {
    return err  // ç›´æ¥è¿”å›é”™è¯¯ï¼Œå¯¼è‡´åˆ é™¤å¤±è´¥
}
```

**ä¿®æ”¹å**ï¼š
```go
// Skip if EmbeddingModelID is empty (e.g., for failed parsing documents)
if knowledge.EmbeddingModelID == "" {
    logger.GetLogger(ctx).WithField("knowledge_id", knowledge.ID).
        Warnf("DeleteKnowledge skipping embedding deletion: EmbeddingModelID is empty")
    return nil
}
embeddingModel, err := s.modelService.GetEmbeddingModel(ctx, knowledge.EmbeddingModelID)
if err != nil {
    logger.GetLogger(ctx).WithField("error", err).WithField("embedding_model_id", knowledge.EmbeddingModelID).
        Warnf("DeleteKnowledge failed to get embedding model, skipping embedding deletion")
    return nil // Continue deletion even if embedding model is not found
}
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… æ£€æŸ¥ `EmbeddingModelID` æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™è·³è¿‡
- âœ… è·å– embedding model å¤±è´¥æ—¶è®°å½•è­¦å‘Šå¹¶ç»§ç»­
- âœ… åˆ é™¤ embeddings å¤±è´¥æ—¶è®°å½•è­¦å‘Šå¹¶ç»§ç»­

##### ä¿®æ”¹2ï¼šåˆ é™¤ Chunks çš„å®¹é”™å¤„ç†

**ä¿®æ”¹å‰**ï¼š
```go
if err := s.chunkService.DeleteChunksByKnowledgeID(ctx, knowledge.ID); err != nil {
    return err  // ç›´æ¥è¿”å›é”™è¯¯
}
```

**ä¿®æ”¹å**ï¼š
```go
if err := s.chunkService.DeleteChunksByKnowledgeID(ctx, knowledge.ID); err != nil {
    logger.GetLogger(ctx).WithField("error", err).Warnf("DeleteKnowledge failed to delete chunks, continuing with other deletions")
    return nil // Continue deletion even if chunk deletion fails
}
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… åˆ é™¤ chunks å¤±è´¥æ—¶è®°å½•è­¦å‘Šå¹¶ç»§ç»­ï¼Œä¸ä¸­æ–­åˆ é™¤æµç¨‹

##### ä¿®æ”¹3ï¼šåˆ é™¤çŸ¥è¯†å›¾è°±çš„å®¹é”™å¤„ç†

**ä¿®æ”¹å‰**ï¼š
```go
if err := s.graphEngine.DelGraph(ctx, []types.NameSpace{namespace}); err != nil {
    return err  // ç›´æ¥è¿”å›é”™è¯¯
}
```

**ä¿®æ”¹å**ï¼š
```go
if err := s.graphEngine.DelGraph(ctx, []types.NameSpace{namespace}); err != nil {
    logger.GetLogger(ctx).WithField("error", err).Warnf("DeleteKnowledge failed to delete knowledge graph, continuing with other deletions")
    return nil // Continue deletion even if graph deletion fails
}
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… åˆ é™¤çŸ¥è¯†å›¾è°±å¤±è´¥æ—¶è®°å½•è­¦å‘Šå¹¶ç»§ç»­

#### 2. `DeleteKnowledgeList` å‡½æ•°ï¼ˆæ‰¹é‡åˆ é™¤ï¼‰

##### ä¿®æ”¹1ï¼šæ‰¹é‡åˆ é™¤ Embeddings çš„å®¹é”™å¤„ç†

**ä¿®æ”¹å‰**ï¼š
```go
group := map[string][]string{}
for _, knowledge := range knowledgeList {
    group[knowledge.EmbeddingModelID] = append(group[knowledge.EmbeddingModelID], knowledge.ID)
}
for embeddingModelID, knowledgeList := range group {
    embeddingModel, err := s.modelService.GetEmbeddingModel(ctx, embeddingModelID)
    if err != nil {
        return err  // ç›´æ¥è¿”å›é”™è¯¯
    }
    // ...
}
```

**ä¿®æ”¹å**ï¼š
```go
group := map[string][]string{}
for _, knowledge := range knowledgeList {
    // Skip if EmbeddingModelID is empty (e.g., for failed parsing documents)
    if knowledge.EmbeddingModelID != "" {
        group[knowledge.EmbeddingModelID] = append(group[knowledge.EmbeddingModelID], knowledge.ID)
    }
}
for embeddingModelID, knowledgeIDs := range group {
    embeddingModel, err := s.modelService.GetEmbeddingModel(ctx, embeddingModelID)
    if err != nil {
        logger.GetLogger(ctx).WithField("error", err).WithField("embedding_model_id", embeddingModelID).
            Warnf("DeleteKnowledge failed to get embedding model, skipping embedding deletion for this model")
        continue // Continue with other models even if one fails
    }
    // ...
}
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… åœ¨åˆ†ç»„æ—¶è·³è¿‡ `EmbeddingModelID` ä¸ºç©ºçš„æ–‡æ¡£
- âœ… è·å– embedding model å¤±è´¥æ—¶ä½¿ç”¨ `continue` ç»§ç»­å¤„ç†å…¶ä»–æ¨¡å‹
- âœ… åˆ é™¤ embeddings å¤±è´¥æ—¶ä½¿ç”¨ `continue` ç»§ç»­å¤„ç†å…¶ä»–æ¨¡å‹

##### ä¿®æ”¹2å’Œ3ï¼šæ‰¹é‡åˆ é™¤ Chunks å’ŒçŸ¥è¯†å›¾è°±

ä¸å•ä¸ªåˆ é™¤ç±»ä¼¼ï¼Œå°†é”™è¯¯è¿”å›æ”¹ä¸ºè­¦å‘Šè®°å½•å¹¶ç»§ç»­æ‰§è¡Œã€‚

---

## ğŸ“Š æ–‡æ¡£è§£æå¤±è´¥çš„ä¸åŒé˜¶æ®µå’Œèµ„æºçŠ¶æ€

### æ–‡æ¡£å¤„ç†æµç¨‹

```
æ–‡æ¡£ä¸Šä¼ 
  â†“
æ–‡ä»¶éªŒè¯
  â†“
æ–‡æ¡£è§£æï¼ˆprocessDocumentï¼‰
  â†“
åˆ†å—å¤„ç†ï¼ˆprocessChunksï¼‰
  â†“
ç”Ÿæˆ Embeddings
  â†“
æ„å»ºçŸ¥è¯†å›¾è°±
  â†“
å®Œæˆï¼ˆParseStatus = "completed"ï¼‰
```

### è§£æå¤±è´¥çš„ä¸åŒé˜¶æ®µ

#### é˜¶æ®µ1ï¼šæ—©æœŸå¤±è´¥ï¼ˆæ— èµ„æºç”Ÿæˆï¼‰

**å¤±è´¥ä½ç½®**ï¼š`processDocument` å‡½æ•°æ—©æœŸé˜¶æ®µ

**å¤±è´¥åŸå› **ï¼š
- æ–‡ä»¶æ‰“å¼€å¤±è´¥ï¼ˆç¬¬710è¡Œï¼‰
- æ–‡ä»¶è¯»å–å¤±è´¥ï¼ˆç¬¬724è¡Œï¼‰
- æ–‡æ¡£è¯»å–æœåŠ¡è°ƒç”¨å¤±è´¥ï¼ˆç¬¬736è¡Œï¼‰
- å›¾ç‰‡ç±»å‹ä½†æœªå¯ç”¨å¤šæ¨¡æ€ï¼ˆç¬¬691è¡Œï¼‰

**èµ„æºçŠ¶æ€**ï¼š
- âŒ æ²¡æœ‰ç”Ÿæˆ chunks
- âŒ æ²¡æœ‰ç”Ÿæˆ embeddings
- âŒ æ²¡æœ‰æ„å»ºçŸ¥è¯†å›¾è°±
- âŒ `EmbeddingModelID` å¯èƒ½ä¸ºç©º

**ä»£ç ä½ç½®**ï¼š
```go
// WeKnora/internal/application/service/knowledge.go:710-732
f, err := file.Open()
if err != nil {
    knowledge.ParseStatus = "failed"
    knowledge.ErrorMessage = err.Error()
    s.repo.UpdateKnowledge(ctx, knowledge)
    return  // æ­¤æ—¶æ²¡æœ‰ä»»ä½•èµ„æºç”Ÿæˆ
}
```

#### é˜¶æ®µ2ï¼šä¸­æœŸå¤±è´¥ï¼ˆå¯èƒ½å·²ç”Ÿæˆéƒ¨åˆ†èµ„æºï¼‰

**å¤±è´¥ä½ç½®**ï¼š`processChunks` å‡½æ•°ä¸­

**å¤±è´¥åŸå› **ï¼š
- è·å– embedding model å¤±è´¥ï¼ˆç¬¬877è¡Œï¼‰
- åˆ›å»º retrieve engine å¤±è´¥ï¼ˆç¬¬1133è¡Œï¼‰
- å­˜å‚¨é…é¢ä¸è¶³ï¼ˆç¬¬1158è¡Œï¼‰
- ä¿å­˜ chunks å¤±è´¥ï¼ˆç¬¬1170è¡Œï¼‰

**èµ„æºçŠ¶æ€**ï¼š
- âš ï¸ å¯èƒ½å·²ç»åˆ›å»ºäº†éƒ¨åˆ† chunksï¼ˆå–å†³äºå¤±è´¥æ—¶æœºï¼‰
- âŒ æ²¡æœ‰ç”Ÿæˆ embeddings
- âŒ æ²¡æœ‰æ„å»ºçŸ¥è¯†å›¾è°±
- âš ï¸ `EmbeddingModelID` å¯èƒ½å·²è®¾ç½®ä½†æ— æ•ˆ

**ä»£ç ä½ç½®**ï¼š
```go
// WeKnora/internal/application/service/knowledge.go:1133-1177
retrieveEngine, err := retriever.NewCompositeRetrieveEngine(...)
if err != nil {
    knowledge.ParseStatus = "failed"
    // æ­¤æ—¶å¯èƒ½å·²ç»åˆ›å»ºäº†éƒ¨åˆ† chunks
    return
}
```

#### é˜¶æ®µ3ï¼šåæœŸå¤±è´¥ï¼ˆå·²ç”Ÿæˆ chunksï¼Œä½† embeddings å¤±è´¥ï¼‰

**å¤±è´¥ä½ç½®**ï¼š`processChunks` å‡½æ•°åæœŸï¼Œ`BatchIndex` å¤±è´¥

**å¤±è´¥åŸå› **ï¼š
- å‘é‡ç´¢å¼•ä¿å­˜å¤±è´¥ï¼ˆç¬¬1180è¡Œï¼‰

**èµ„æºçŠ¶æ€**ï¼š
- âœ… å·²ä¿å­˜ chunks åˆ°æ•°æ®åº“
- âŒ embeddings ä¿å­˜å¤±è´¥
- âŒ æ²¡æœ‰æ„å»ºçŸ¥è¯†å›¾è°±
- âœ… `EmbeddingModelID` å·²è®¾ç½®

**è‡ªåŠ¨æ¸…ç†æœºåˆ¶**ï¼š
```go
// WeKnora/internal/application/service/knowledge.go:1187-1197
// delete failed chunks
if err := s.chunkService.DeleteChunksByKnowledgeID(ctx, knowledge.ID); err != nil {
    logger.Errorf(ctx, "Delete chunks failed: %v", err)
}

// delete index
if err := retrieveEngine.DeleteByKnowledgeIDList(
    ctx, []string{knowledge.ID}, embeddingModel.GetDimensions(),
); err != nil {
    logger.Errorf(ctx, "Delete index failed: %v", err)
}
```

**è¯´æ˜**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨æ¸…ç†å·²åˆ›å»ºçš„ chunks å’Œç´¢å¼•ï¼Œä½†å¯èƒ½æ¸…ç†ä¸å½»åº•ã€‚

---

## ğŸ—‘ï¸ åˆ é™¤æ“ä½œçš„è¡Œä¸º

### åˆ é™¤æ“ä½œä¼šå°è¯•åˆ é™¤çš„å†…å®¹

åˆ é™¤è§£æå¤±è´¥çš„æ–‡æ¡£æ—¶ï¼Œç³»ç»Ÿä¼šå°è¯•åˆ é™¤ä»¥ä¸‹æ‰€æœ‰å·²ç”Ÿæˆçš„å†…å®¹ï¼š

#### 1. **åˆ é™¤ Embeddingsï¼ˆå‘é‡ç´¢å¼•ï¼‰**

```go
// åˆ é™¤å‘é‡å­˜å‚¨ä¸­çš„ embeddings
retrieveEngine.DeleteByKnowledgeIDList(ctx, []string{knowledge.ID}, embeddingModel.GetDimensions())
```

**è¡Œä¸º**ï¼š
- å¦‚æœ `EmbeddingModelID` ä¸ºç©ºï¼Œè·³è¿‡åˆ é™¤å¹¶è®°å½•è­¦å‘Š
- å¦‚æœè·å– embedding model å¤±è´¥ï¼Œè·³è¿‡åˆ é™¤å¹¶è®°å½•è­¦å‘Š
- å¦‚æœåˆ é™¤å¤±è´¥ï¼Œè®°å½•è­¦å‘Šå¹¶ç»§ç»­

#### 2. **åˆ é™¤ Chunksï¼ˆæ–‡æ¡£å—ï¼‰**

```go
// åˆ é™¤æ‰€æœ‰å…³è”çš„ chunks
s.chunkService.DeleteChunksByKnowledgeID(ctx, knowledge.ID)
```

**è¡Œä¸º**ï¼š
- å¦‚æœåˆ é™¤å¤±è´¥ï¼Œè®°å½•è­¦å‘Šå¹¶ç»§ç»­
- å³ä½¿ chunks ä¸å­˜åœ¨ï¼Œä¹Ÿä¸ä¼šä¸­æ–­åˆ é™¤æµç¨‹

#### 3. **åˆ é™¤çŸ¥è¯†å›¾è°±**

```go
// åˆ é™¤çŸ¥è¯†å›¾è°±
s.graphEngine.DelGraph(ctx, []types.NameSpace{namespace})
```

**è¡Œä¸º**ï¼š
- å¦‚æœåˆ é™¤å¤±è´¥ï¼Œè®°å½•è­¦å‘Šå¹¶ç»§ç»­
- å³ä½¿å›¾è°±ä¸å­˜åœ¨ï¼Œä¹Ÿä¸ä¼šä¸­æ–­åˆ é™¤æµç¨‹

#### 4. **åˆ é™¤ç‰©ç†æ–‡ä»¶**

```go
// åˆ é™¤ç‰©ç†æ–‡ä»¶
if knowledge.FilePath != "" {
    s.fileSvc.DeleteFile(ctx, knowledge.FilePath)
}
```

**è¡Œä¸º**ï¼š
- å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨æˆ–åˆ é™¤å¤±è´¥ï¼Œè®°å½•é”™è¯¯ä½†ç»§ç»­æ‰§è¡Œ

#### 5. **åˆ é™¤æ•°æ®åº“è®°å½•**

```go
// åˆ é™¤çŸ¥è¯†åº“æ–‡æ¡£è®°å½•æœ¬èº«
s.repo.DeleteKnowledge(ctx, tenantID, id)
```

**è¡Œä¸º**ï¼š
- è¿™æ˜¯å…³é”®æ“ä½œï¼Œå¿…é¡»æˆåŠŸ
- å¦‚æœå¤±è´¥ï¼Œæ•´ä¸ªåˆ é™¤æ“ä½œå¤±è´¥

### å®¹é”™å¤„ç†æœºåˆ¶

#### å…³é”®é”™è¯¯ vs éå…³é”®é”™è¯¯

| é”™è¯¯ç±»å‹ | å¤„ç†æ–¹å¼ | ç¤ºä¾‹ |
|---------|---------|------|
| **å…³é”®é”™è¯¯** | è¿”å›é”™è¯¯ï¼Œä¸­æ–­åˆ é™¤ | æ•°æ®åº“åˆ é™¤å¤±è´¥ |
| **éå…³é”®é”™è¯¯** | è®°å½•è­¦å‘Šï¼Œç»§ç»­æ‰§è¡Œ | Embeddings åˆ é™¤å¤±è´¥ã€Chunks åˆ é™¤å¤±è´¥ã€çŸ¥è¯†å›¾è°±åˆ é™¤å¤±è´¥ |

#### èµ„æºå­˜åœ¨æ€§æ£€æŸ¥

- âœ… æ£€æŸ¥ `EmbeddingModelID` æ˜¯å¦ä¸ºç©º
- âœ… æ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨ï¼ˆé€šè¿‡åˆ é™¤æ“ä½œçš„è¿”å›å€¼åˆ¤æ–­ï¼‰
- âœ… åŒºåˆ†"èµ„æºä¸å­˜åœ¨"å’Œ"åˆ é™¤æ“ä½œå¤±è´¥"

---

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœ

### è§£å†³çš„é—®é¢˜

1. âœ… **è§£æå¤±è´¥çš„æ–‡æ¡£å¯ä»¥æ­£å¸¸åˆ é™¤**
   - ä¸å†å› ä¸ºèµ„æºç¼ºå¤±å¯¼è‡´åˆ é™¤å¤±è´¥
   - ç”¨æˆ·å¯ä»¥æ¸…ç†å¤±è´¥çš„æ–‡æ¡£

2. âœ… **æ›´å¥½çš„é”™è¯¯å¤„ç†**
   - åŒºåˆ†å…³é”®é”™è¯¯å’Œéå…³é”®é”™è¯¯
   - æä¾›è¯¦ç»†çš„è­¦å‘Šæ—¥å¿—

3. âœ… **æé«˜ç³»ç»Ÿå¥å£®æ€§**
   - èƒ½å¤Ÿå¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
   - é¿å…å› éƒ¨åˆ†èµ„æºé—®é¢˜å¯¼è‡´æ•´ä¸ªæ“ä½œå¤±è´¥

### å®é™…æ•ˆæœ

#### ä¼˜åŒ–å‰
```
åˆ é™¤è§£æå¤±è´¥çš„æ–‡æ¡£
  â†“
å°è¯•åˆ é™¤ embeddings â†’ EmbeddingModelID ä¸ºç©º â†’ è·å– model å¤±è´¥
  â†“
è¿”å›é”™è¯¯ â†’ æ•´ä¸ªåˆ é™¤æ“ä½œå¤±è´¥
  â†“
æ–‡æ¡£è®°å½•æ®‹ç•™åœ¨æ•°æ®åº“ä¸­ âŒ
```

#### ä¼˜åŒ–å
```
åˆ é™¤è§£æå¤±è´¥çš„æ–‡æ¡£
  â†“
æ£€æŸ¥ EmbeddingModelID â†’ ä¸ºç©º â†’ è·³è¿‡åˆ é™¤ embeddingsï¼ˆè®°å½•è­¦å‘Šï¼‰
  â†“
å°è¯•åˆ é™¤ chunks â†’ ä¸å­˜åœ¨ â†’ è®°å½•è­¦å‘Šå¹¶ç»§ç»­
  â†“
å°è¯•åˆ é™¤çŸ¥è¯†å›¾è°± â†’ ä¸å­˜åœ¨ â†’ è®°å½•è­¦å‘Šå¹¶ç»§ç»­
  â†“
åˆ é™¤ç‰©ç†æ–‡ä»¶ â†’ æˆåŠŸæˆ–å¤±è´¥ï¼ˆè®°å½•æ—¥å¿—ï¼‰
  â†“
åˆ é™¤æ•°æ®åº“è®°å½• â†’ æˆåŠŸ
  â†“
æ–‡æ¡£è®°å½•æˆåŠŸåˆ é™¤ âœ…
```

---

## ğŸ” ä»£ç ä½ç½®

### ä¿®æ”¹çš„æ–‡ä»¶

- `WeKnora/internal/application/service/knowledge.go`
  - `DeleteKnowledge` å‡½æ•°ï¼ˆç¬¬446-520è¡Œï¼‰
  - `DeleteKnowledgeList` å‡½æ•°ï¼ˆç¬¬522-611è¡Œï¼‰

### ç›¸å…³ä»£ç 

- `WeKnora/internal/application/service/knowledge.go`
  - `processDocument` å‡½æ•°ï¼ˆç¬¬669-777è¡Œï¼‰ï¼šæ–‡æ¡£å¤„ç†æµç¨‹
  - `processChunks` å‡½æ•°ï¼ˆç¬¬862-1229è¡Œï¼‰ï¼šåˆ†å—å¤„ç†å’Œ embeddings ç”Ÿæˆ

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. **ä»ä¸¥æ ¼æ¨¡å¼åˆ°å®¹é”™æ¨¡å¼**ï¼šå…è®¸éå…³é”®èµ„æºåˆ é™¤å¤±è´¥ï¼Œç¡®ä¿æ•°æ®åº“è®°å½•èƒ½å¤ŸæˆåŠŸåˆ é™¤
2. **çŠ¶æ€æ„ŸçŸ¥**ï¼šæ£€æŸ¥èµ„æºæ˜¯å¦å­˜åœ¨ï¼Œé¿å…å¯¹ä¸å­˜åœ¨èµ„æºçš„æ“ä½œ
3. **é”™è¯¯åˆ†ç±»**ï¼šåŒºåˆ†å…³é”®é”™è¯¯å’Œéå…³é”®é”™è¯¯ï¼Œé‡‡ç”¨ä¸åŒçš„å¤„ç†ç­–ç•¥
4. **è¯¦ç»†æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰æ“ä½œå’Œè­¦å‘Šï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

### è®¾è®¡åŸåˆ™

- **ä¼˜å…ˆä¿è¯æ ¸å¿ƒæ“ä½œæˆåŠŸ**ï¼šæ•°æ®åº“è®°å½•åˆ é™¤æ˜¯æ ¸å¿ƒæ“ä½œï¼Œå¿…é¡»æˆåŠŸ
- **å®¹é”™å¤„ç†éå…³é”®æ“ä½œ**ï¼šèµ„æºåˆ é™¤å¤±è´¥ä¸åº”é˜»æ­¢æ–‡æ¡£è®°å½•åˆ é™¤
- **æä¾›è¯¦ç»†åé¦ˆ**ï¼šé€šè¿‡æ—¥å¿—è®°å½•æ‰€æœ‰æ“ä½œçŠ¶æ€ï¼Œä¾¿äºç›‘æ§å’Œæ’æŸ¥

### é€‚ç”¨åœºæ™¯

- âœ… è§£æå¤±è´¥çš„æ–‡æ¡£åˆ é™¤
- âœ… éƒ¨åˆ†èµ„æºç¼ºå¤±çš„æ–‡æ¡£åˆ é™¤
- âœ… èµ„æºå·²æ‰‹åŠ¨æ¸…ç†çš„æ–‡æ¡£åˆ é™¤
- âœ… æ­£å¸¸æ–‡æ¡£çš„åˆ é™¤ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [WeKnora ç§Ÿæˆ·ä¿¡æ¯è¯´æ˜](./WeKnoraç§Ÿæˆ·ä¿¡æ¯è¯´æ˜.md)
- [API æ–‡æ¡£](../docs/API.md)
- [WeKnora ä½¿ç”¨æ–‡æ¡£](../docs/WeKnora.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-11-11  
**ç»´æŠ¤è€…**ï¼šWeKnora å¼€å‘å›¢é˜Ÿ

